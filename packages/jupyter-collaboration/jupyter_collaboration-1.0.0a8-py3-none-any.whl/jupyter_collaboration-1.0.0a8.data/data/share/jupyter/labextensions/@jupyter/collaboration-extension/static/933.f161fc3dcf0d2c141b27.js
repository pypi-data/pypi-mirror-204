"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[933,8],{2008:(e,t,s)=>{s.r(t),s.d(t,{ICollaborativeDrive:()=>p,WebSocketProvider:()=>h,YDrive:()=>d});var o=s(60),r=s(4989),n=s(8256),i=s(7930),a=s(4901),c=s(7099);class h{constructor(e){this._onConnectionClosed=e=>{1003===e.code&&(console.error("Document provider closed:",e.reason),(0,o.showErrorMessage)(this._trans.__("Session expired"),this._trans.__("The document session expired. You need to reload this browser tab."),[o.Dialog.okButton({label:this._trans.__("Reload")})]).then((e=>{e.button.accept&&window.location.reload()})).catch((e=>window.location.reload())),this._sharedModel.dispose())},this._ready=new i.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect()}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){var e,t;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.destroy(),a.Signal.clearData(this))}_connect(){(async function(e,t,s){const{makeSettings:o,makeRequest:i,ResponseError:a}=n.ServerConnection,c=o(),h=r.URLExt.join(c.baseUrl,"api/collaboration/session",encodeURIComponent(s)),d={method:"PUT",body:JSON.stringify({format:e,type:t})},l=await i(h,d,c);if(200!==l.status&&201!==l.status)throw new a(l);return l.json()})(this._format,this._contentType,this._path).then((e=>{this._yWebsocketProvider=new c.WebsocketProvider(this._serverUrl,`${e.format}:${e.type}:${e.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:e.sessionId},awareness:this._awareness}),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)})).then((e=>this._ready.resolve())).catch((e=>console.warn(e)))}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}class d extends n.Drive{constructor(e,t){super({name:"RTC"}),this._onCreate=(e,t)=>{if("string"==typeof e.format)try{const s=new h({url:r.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),n=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(n,s),t.disposed.connect((()=>{const e=this._providers.get(n);e&&(e.dispose(),this._providers.delete(n))}));for(const t of this._providers.keys()){if(t===n)continue;const s=t.split(":")[2];e.path===s&&(0,o.showDialog)({title:this._trans.__("Warning"),body:this._trans.__("Opening a document with multiple views simultaneously is not supported.Please, close one view otherwise, you might lose some of your changes."),buttons:[o.Dialog.okButton()]})}}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._user=e,this._trans=t,this._providers=new Map,this.sharedModelFactory=new l(this._onCreate)}dispose(){this.isDisposed||(this._providers.forEach((e=>e.dispose())),this._providers.clear(),super.dispose())}async get(e,t){if(t&&t.format&&t.type){const s=`${t.format}:${t.type}:${e}`,o=this._providers.get(s);if(o){const s=super.get(e,{...t,content:!1});return await o.ready,s}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const s=`${t.format}:${t.type}:${e}`;if(this._providers.get(s))return this.get(e,{...t,content:!1})}return super.save(e,t)}}class l{constructor(e){this._onCreate=e,this.collaborative=!0,this._documentFactories=new Map}registerDocumentFactory(e,t){if(this._documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this._documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(e.collaborative&&this._documentFactories.has(e.contentType)){const t=this._documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}const p=new i.Token("@jupyter/collaboration-extension:ICollaborativeDrive")}}]);