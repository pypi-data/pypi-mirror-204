import click
from vhcs.common.ctxp import profile
from vhcs.service import pki
from vhcs.util import pki_util
from vhcs.common.sglib.util import option_org_id, get_org_id


def _write_file(file_path: str, text: str):
    with open(file_path, "w") as file:
        file.write(text)


@click.command()
@click.argument("resource-name", type=str, required=True)
@click.option(
    "--key-length",
    type=int,
    default=2048,
    required=False,
    help="Private key length",
)
@option_org_id
def sign_resource_cert(resource_name: str, key_length: int, org: str):
    """Get the certificate for a specific resource"""
    org_id = get_org_id(org)
    csr_pem, private_key_pem = pki_util.generate_CSR(resource_name, key_length=key_length)
    ret = pki.sign_resource_cert(org_id, csr_pem)

    long_name = f"{profile.name()}-{org_id}-{resource_name}"
    key_file = resource_name + ".key"
    print("Private key (generated by CLI): " + key_file)
    _write_file(key_file, private_key_pem)

    client_cert_chain_file = long_name + ".crt"
    print("Signed resource certificate with chain (response from server): " + client_cert_chain_file)
    _write_file(client_cert_chain_file, ret)
